<p id="notice"><%= notice %></p>

<div id='calendar' style='margin:3em 0;font-size:10px'></div>

<div id="clickRes" class="modal hide fade">

</div>

<div id="roomEvents" class="modal hide fade">

</div>

<%= link_to 'Edit', edit_room_path(@room) %> |
<%= link_to 'Back', rooms_path %>


<script type='text/javascript'>

    var calendar;
    $(document).ready(function () {


        $("#roomEvents").html('<%= escape_javascript(render :template => "rooms/edit", :formats => [:html], :handlers => [:erb]) %>');
        $('#roomEvents').modal('toggle');
        $(".datepicker").datepicker({ dateFormat:'yy-mm-dd' });


        var date = new Date();
        var d = date.getDate();
        var m = date.getMonth();
        var y = date.getFullYear();

        calendar = $('#calendar').fullCalendar({
            header:{
                left:'prev,next today',
                center:'title',
                right:'month,agendaWeek,agendaDay'
            },
            selectable:true,
            theme:true,
            selectHelper:true,
            editable:true,
            events:<%=  @Jevents.html_safe  %>,
            eventRender:function (event, element) {
                element.find('.fc-event-title').append("<br/><br/>$ " + event.price);
            },

            select:function (start, end, allDay, jsEvent, view, resource) {

                var pobj = {event:{start_date:start.getFullYear().toString() + '-' + (start.getMonth() + 1).toString() + '-' + start.getDate(),
                                    end_date:end.getFullYear().toString() + '-' + (end.getMonth() + 1).toString() + '-' + end.getDate(), room_id: '<%= @room.id  %>'},
                            authenticity_token:'<%= form_authenticity_token  %>',
                            eType: 'select'};

                var url = '/events/new';

                $.get(url, pobj, function (data) {
                    $("#clickRes").html(data);
                    $('#clickRes').modal('toggle');
                });
            },
            eventDrop:function (event, dayDelta, minuteDelta, allDay, revertFunc, jsEvent, ui, view) {

                var start = event.start;
                var end = event.end;
                var ide = event.id;
                var droppable = true;
                calendar.fullCalendar('clientEvents', function (event) {
                    if(ide != event.id && start.toString() == event.start.toString()){
                        droppable = false;
                    }
                });
                if (event.end != null) {
                    var pobj = { id:event.id,
                        event:{start_date:event.start.toDateString(), end_date:event.end.toDateString(), room_id: '<%= @room.id  %>' },
                        authenticity_token:'<%= form_authenticity_token  %>',
                        eType: 'drop'};
                } else {
                    var pobj = { id:event.id,
                        event:{start_date:event.start.toDateString(), end_date:event.start.toDateString(), room_id: '<%= @room.id  %>'},
                        authenticity_token:'<%= form_authenticity_token  %>',
                        eType: 'drop' };
                }

                $.ajax({
                    type:"PUT",
                    dataType:'script',
                    url:'/events/' + event.id,
                    data: pobj,
                    success:function () {
                    },
                    error:function (e) {
                        revertFunc();
                    }
                });

            },

            eventResize:function (event, dayDelta, minuteDelta, revertFunc, jsEvent, ui, view) {

                if (event.end != null) {
                    var pobj = { id:event.id,
                        event:{name: event.title, price: event.price, start_date:event.start.toDateString(),
                            end_date:event.end.toDateString(), color:event.backgroundColor, room_id: '<%= @room.id  %>'},
                        authenticity_token:'<%= form_authenticity_token  %>',
                        room_id: '<%= @room.id  %>',
                        eType: 'resize'};

                } else {
                    var pobj = { id:event.id,
                        calendar:{name: event.title, price: event.price, start_date:event.start.toDateString(),
                            end_date:event.start.toDateString(), color:event.backgroundColor, room_id: '<%= @room.id  %>'},
                        authenticity_token:'<%= form_authenticity_token  %>',
                        eType: 'resize'};
                }

                $.ajax({
                    type:"POST",
                    dataType:'script',
                    url:'/events#create',
                    data:pobj,
                    success:function () {
                    },
                    error:function () {
                        revertFunc();
                        calendar.fullCalendar('refetchEvents');
                    }
                });
            },
            eventClick:function (event, jsEvent, view) {

                var url = '<%= edit_room_path(@room) %>';

                $.get(url, {eid: event.id, from: 'click'}, function (data) {
                });
            },
            windowResize:function (view) {
                calendar.fullCalendar('option', 'height', $(window).height() - 40);
            }
        });

    });

</script>
